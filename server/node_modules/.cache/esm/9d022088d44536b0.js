let Joi,REF_SECRET,RefreshToken,Teacher,Student,CustomErrorHandler,JwtService;_d44‍.x([["default",()=>_d44‍.o]]);_d44‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_d44‍.w("../../config",[["REF_SECRET",["REF_SECRET"],function(v){REF_SECRET=v}]]);_d44‍.w("../../models",[["RefreshToken",["RefreshToken"],function(v){RefreshToken=v}],["Teacher",["Teacher"],function(v){Teacher=v}],["Student",["Student"],function(v){Student=v}]]);_d44‍.w("../../services/CustomErrorHandler",[["default",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_d44‍.w("../../services/JwtService",[["default",["JwtService"],function(v){JwtService=v}]]);





const refreshController = {
    async srefresh(req,res,next){
        //validation
        const refreshSchema = Joi.object({
            refresh_token: Joi.string().required(),
            
        });

        const {error} = refreshSchema.validate(req.body);

        if(error)
        {
            return next(error);
        }

        //check in database
        let refreshtoken;

        try{
            refreshtoken = await RefreshToken.findOne({token:req.body.refresh_token});
            if(!refreshtoken){
                return next(CustomErrorHandler.unAuthorized('Invalid refresh token'));
            }

            let userId;
            try{
                const { _id } = await JwtService.verify(refreshtoken.token,REF_SECRET);
                userId = _id;
            }catch(err){
                return next(CustomErrorHandler.unAuthorized('Invalid refresh token'));
            }

            
            const student=await Student.findOne({_id:userId});
            if(!student ){
                return next(CustomErrorHandler.unAuthorized('No user found'));
            }
 
            //tokens
            //token generate
            const access_token = JwtService.sign({_id:student._id,role:student.role});
            const refresh_token = JwtService.sign({_id:student._id,role:student.role},'1y',REF_SECRET);

            //Refresh token Send to database
            await RefreshToken.create({token: refresh_token});

            res.json({access_token:access_token,refresh_token:refresh_token}); 


        }catch(err){
            return next(new Error('Somthing went wrong'+err.message));
        }

    },
    async trefresh(req,res,next){
        //validation
        const refreshSchema = Joi.object({
            refresh_token: Joi.string().required(),
            
        });

        const {error} = refreshSchema.validate(req.body);

        if(error)
        {
            return next(error);
        }

        //check in database
        let refreshtoken;

        try{
            refreshtoken = await RefreshToken.findOne({token:req.body.refresh_token});
            if(!refreshtoken){
                return next(CustomErrorHandler.unAuthorized('Invalid refresh token'));
            }

            let userId;
            try{
                const { _id } = await JwtService.verify(refreshtoken.token,REF_SECRET);
                userId = _id;
            }catch(err){
                return next(CustomErrorHandler.unAuthorized('Invalid refresh token'));
            }

            const teacher=await Teacher.findOne({_id:userId});
            
            if(!teacher ){
                return next(CustomErrorHandler.unAuthorized('No user found'));
            }
 
            //tokens
            //token generate
            const access_token = JwtService.sign({_id:teacher._id,role:teacher.role});
            const refresh_token = JwtService.sign({_id:teacher._id,role:teacher.role},'1y',REF_SECRET);

            //Refresh token Send to database
            await RefreshToken.create({token: refresh_token});

            res.json({access_token:access_token,refresh_token:refresh_token}); 


        }catch(err){
            return next(new Error('Somthing went wrong : '+err.message));
        }

    }
}

_d44‍.d(refreshController);